<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>W04 Task 2 – Bars with Labels (Anim + Axis)</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    .label { font-size: 12px; dominant-baseline: middle; }
    .value { font-size: 12px; dominant-baseline: middle; }
  </style>
</head>
<body>
<h2>W04 Task 2 : Labeled Horizontal Bars</h2>

<script>
const W = 560, Hmin = 220;
const pad = { top: 10, right: 24, bottom: 30, left: 90 }; 
const barH = 24, gap = 8;

const svg = d3.select("body").append("svg")
  .attr("width", W)
  .attr("height", Hmin)
  .style("background", "#f8f8f8");

d3.csv("w04_task2.csv").then(data => {
  data.forEach(d => d.value = +d.value);

  const maxV = d3.max(data, d => d.value) || 1;
  const innerW = W - pad.left - pad.right;

 
  const x = d3.scaleLinear().domain([0, maxV]).range([0, innerW]);
  const xAxis = d3.axisBottom(x).ticks(5);

  
  const innerH = data.length * (barH + gap) - gap;
  const needH = pad.top + innerH + pad.bottom;
  svg.attr("height", Math.max(Hmin, needH));

  
  const g = svg.append("g").attr("transform", `translate(${pad.left},${pad.top})`);

  
  const bars = g.selectAll("rect").data(data).enter().append("rect")
    .attr("x", 0)
    .attr("y", (_, i) => i * (barH + gap))
    .attr("width", 0)           
    .attr("height", barH)
    .attr("rx", 4)
    .style("fill", d => d.color || "steelblue")
    .transition().duration(800)
    .attr("width", d => x(d.value)); 

  svg.append("g").attr("transform", `translate(${pad.left - 8},${pad.top})`)
    .selectAll("text").data(data).enter().append("text")
    .attr("class", "label")
    .attr("x", 0)
    .attr("y", (_, i) => i * (barH + gap) + barH / 2)
    .attr("text-anchor", "end")
    .text(d => d.label);

  
  const fmt = d3.format(",");
  const values = g.selectAll(".value").data(data).enter().append("text")
    .attr("class", "value")
    .attr("x", 4) 
    .attr("y", (_, i) => i * (barH + gap) + barH / 2)
    .text(d => fmt(d.value))
    .attr("opacity", 0.0)
    .transition().duration(800)
    .attr("x", d => x(d.value) + 4) 
    .attr("opacity", 1.0);

 
  svg.append("g")
    .attr("transform", `translate(${pad.left},${pad.top + innerH + 2})`)
    .call(xAxis);
}).catch(err => {
  console.error("CSV load failed:", err);
  d3.select("body").append("p").text("CSVの読み込みに失敗しました。");
});
</script>
</body>
</html>

